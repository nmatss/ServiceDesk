# Security & Load Testing - Quick Reference

Fast reference guide for running security scans and load tests.

## Security Testing

### Quick Commands

```bash
# Run full security scan
npm run security:scan

# Run security scan + OWASP tests
npm run security:scan-full

# Run specific OWASP tests
npm run test:security:owasp

# Run all security tests
npm run test:security
```

### Security Scan Checks

✅ Dependency vulnerabilities (npm audit)
✅ Hardcoded secrets detection
✅ SQL injection patterns
✅ XSS vulnerabilities
✅ Dangerous code patterns (eval, etc.)
✅ Weak cryptography (MD5, SHA1)
✅ Authentication issues

### Reports Location

```
reports/security/
├── security-scan-{timestamp}.txt    # Full security report
└── npm-audit-{timestamp}.json       # NPM audit JSON output
```

### Common Vulnerabilities & Fixes

#### SQL Injection
```typescript
// ❌ Vulnerable
db.prepare(`SELECT * FROM users WHERE id = ${id}`).get()

// ✅ Secure
db.prepare('SELECT * FROM users WHERE id = ?').get(id)
```

#### Hardcoded Secrets
```typescript
// ❌ Vulnerable
const JWT_SECRET = "my-secret-key"

// ✅ Secure
const JWT_SECRET = process.env.JWT_SECRET || throwError('Required')
```

#### XSS Prevention
```typescript
// ❌ Vulnerable
<div dangerouslySetInnerHTML={{ __html: userContent }} />

// ✅ Secure
import DOMPurify from 'dompurify'
<div dangerouslySetInnerHTML={{ __html: DOMPurify.sanitize(userContent) }} />
```

## Load Testing

### Quick Commands

```bash
# Run all load tests (interactive)
npm run load:test:all

# Run individual tests
npm run load:test              # Ticket creation
npm run load:test:search       # Search & knowledge base
npm run load:test:stress       # Stress test (aggressive)

# Analyze results
npm run load:analyze reports/load/results.json
```

### Prerequisites

**Install K6:**
```bash
# macOS
brew install k6

# Linux (Ubuntu/Debian)
sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
sudo apt-get update && sudo apt-get install k6

# Windows
choco install k6

# Verify
k6 version
```

**Start Application:**
```bash
npm run dev
# Or
npm run build && npm start
```

### Load Test Profiles

#### 1. Ticket Creation Test
- **VUs:** 20 → 50 → 100 → 200
- **Duration:** ~5 minutes
- **Tests:** Auth, ticket CRUD, database writes
- **Target:** P95 < 500ms, Success > 95%

#### 2. Search & Knowledge Base
- **VUs:** 30 → 75 → 150 → 300
- **Duration:** ~4 minutes
- **Tests:** Search, KB retrieval, read operations
- **Target:** P95 < 800ms, Success > 95%

#### 3. Stress Test
- **VUs:** 100 → 200 → 500 → 1000
- **Duration:** ~9 minutes
- **Tests:** All endpoints, breaking point
- **Target:** Error rate < 10%

### Custom Test Runs

```bash
# Quick smoke test (10 users, 30 seconds)
k6 run --vus 10 --duration 30s tests/load/ticket-creation.js

# Specific load (50 users, 2 minutes)
k6 run --vus 50 --duration 2m tests/load/ticket-creation.js

# Different environment
k6 run -e BASE_URL=https://staging.example.com tests/load/ticket-creation.js

# Save results to JSON
k6 run --out json=reports/load/results.json tests/load/ticket-creation.js
```

### Performance Targets

| Metric | Excellent | Good | Acceptable | Poor |
|--------|-----------|------|------------|------|
| **P95 Response Time** | < 200ms | < 500ms | < 1000ms | > 1000ms |
| **P99 Response Time** | < 500ms | < 1000ms | < 2000ms | > 2000ms |
| **Success Rate** | > 99% | > 95% | > 90% | < 90% |
| **Concurrent Users** | 500+ | 200+ | 100+ | < 100 |

### Reading K6 Output

```
Key Metrics to Watch:
✓ http_req_duration........: P95 should be < 500ms
✓ http_req_failed..........: Should be < 1%
✓ http_reqs................: Higher is better (requests/sec)
✓ checks...................: Should be > 95%
✓ vus......................: Concurrent virtual users
```

### Reports Location

```
reports/load/
├── ticket-creation-summary.json
├── search-knowledge-summary.json
├── stress-test-summary.json
├── load-test-report-{timestamp}.txt
└── *.html (generated by analyzer)
```

## Troubleshooting

### Security Scan Issues

**Issue:** Permission denied
```bash
chmod +x scripts/security/run-security-scan.sh
```

**Issue:** No reports directory
```bash
mkdir -p reports/security
```

### Load Test Issues

**Issue:** k6 command not found
```bash
# Install k6 (see prerequisites above)
k6 version
```

**Issue:** Connection refused
```bash
# Ensure app is running
curl http://localhost:3000/api/health
```

**Issue:** High error rate
```bash
# Check app logs
tail -f logs/application.log

# Reduce load
k6 run --vus 10 --duration 30s tests/load/ticket-creation.js
```

## CI/CD Integration

### GitHub Actions - Security

```yaml
# .github/workflows/security.yml
- name: Run Security Scan
  run: npm run security:scan-full
```

### GitHub Actions - Load Testing

```yaml
# .github/workflows/load-test.yml
- name: Install K6
  run: |
    sudo apt-get update
    sudo apt-get install k6

- name: Run Load Tests
  run: npm run load:test:all
```

## Best Practices

### Security

1. **Run security scans before every release**
2. **Never commit secrets** - use environment variables
3. **Always use parameterized queries** - prevent SQL injection
4. **Validate all user input** - use Zod schemas
5. **Keep dependencies updated** - run `npm audit` regularly

### Load Testing

1. **Establish baselines** - know your current performance
2. **Test regularly** - weekly or before major releases
3. **Monitor production** - compare with test results
4. **Gradual load increases** - don't spike to max immediately
5. **Clean up test data** - remove load test records

## Quick Checklist

### Pre-Release Security Check
- [ ] Run `npm run security:scan`
- [ ] Run `npm run test:security:owasp`
- [ ] Review security reports
- [ ] Fix all high/critical issues
- [ ] Update dependencies with vulnerabilities

### Pre-Release Performance Check
- [ ] Run `npm run load:test:all`
- [ ] Review performance metrics
- [ ] Ensure P95 < 500ms
- [ ] Ensure success rate > 95%
- [ ] Test under expected peak load

## Resources

### Security
- [SECURITY_TESTING_GUIDE.md](./SECURITY_TESTING_GUIDE.md) - Full security guide
- [OWASP Top 10](https://owasp.org/www-project-top-ten/)
- [npm Security Best Practices](https://docs.npmjs.com/security-best-practices)

### Load Testing
- [LOAD_TESTING_GUIDE.md](./LOAD_TESTING_GUIDE.md) - Full load testing guide
- [K6 Documentation](https://k6.io/docs/)
- [K6 Examples](https://github.com/grafana/k6-examples)

## Contact

For security issues: Open a security issue in GitHub
For performance questions: Contact DevOps team

---

**Last Updated:** 2025-12-13
**Version:** 1.0.0
