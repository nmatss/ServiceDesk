name: Dependency Management

on:
  schedule:
    # Run every Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:
  pull_request:
    paths:
      - 'package.json'
      - 'package-lock.json'

env:
  NODE_VERSION: '20'

jobs:
  # Analyze Dependencies
  dependency-analysis:
    name: Dependency Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Check for outdated dependencies
        run: |
          npm outdated --json > outdated.json || true
          cat outdated.json

      - name: Upload outdated dependencies report
        uses: actions/upload-artifact@v4
        with:
          name: outdated-dependencies
          path: outdated.json
          retention-days: 30

      - name: Check dependency count
        run: |
          DEPS=$(jq '.dependencies | length' package.json)
          DEV_DEPS=$(jq '.devDependencies | length' package.json)
          TOTAL=$((DEPS + DEV_DEPS))
          echo "Total dependencies: $TOTAL"
          echo "Production: $DEPS"
          echo "Development: $DEV_DEPS"

          if [ $TOTAL -gt 150 ]; then
            echo "::warning::High dependency count ($TOTAL). Consider reducing dependencies."
          fi

  # Security Audit
  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Run npm audit
        run: |
          npm audit --json > audit.json || true
          cat audit.json | jq '.'

      - name: Parse audit results
        run: |
          CRITICAL=$(cat audit.json | jq '.metadata.vulnerabilities.critical // 0')
          HIGH=$(cat audit.json | jq '.metadata.vulnerabilities.high // 0')
          MODERATE=$(cat audit.json | jq '.metadata.vulnerabilities.moderate // 0')
          LOW=$(cat audit.json | jq '.metadata.vulnerabilities.low // 0')

          echo "Security vulnerabilities found:"
          echo "Critical: $CRITICAL"
          echo "High: $HIGH"
          echo "Moderate: $MODERATE"
          echo "Low: $LOW"

          if [ "$CRITICAL" -gt 0 ]; then
            echo "::error::Found $CRITICAL critical vulnerabilities!"
            exit 1
          fi

          if [ "$HIGH" -gt 0 ]; then
            echo "::warning::Found $HIGH high vulnerabilities!"
          fi

      - name: Upload audit report
        uses: actions/upload-artifact@v4
        with:
          name: npm-audit-report
          path: audit.json
          retention-days: 30

      - name: Create issue for vulnerabilities
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const audit = JSON.parse(fs.readFileSync('audit.json', 'utf8'));
            const critical = audit.metadata.vulnerabilities.critical || 0;
            const high = audit.metadata.vulnerabilities.high || 0;

            const body = `## Security Vulnerabilities Detected

            A scheduled security audit has detected vulnerabilities in dependencies.

            ### Summary
            - Critical: ${critical}
            - High: ${high}
            - Moderate: ${audit.metadata.vulnerabilities.moderate || 0}
            - Low: ${audit.metadata.vulnerabilities.low || 0}

            ### Action Required
            Run \`npm audit fix\` to automatically fix vulnerabilities, or review them manually.

            ### Details
            See the [workflow run](${context.payload.repository.html_url}/actions/runs/${context.runId}) for full details.

            ---
            _This issue was automatically created by the dependency management workflow._
            `;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸš¨ Security vulnerabilities detected (${critical} critical, ${high} high)`,
              body: body,
              labels: ['security', 'dependencies', 'automated']
            });

  # License Compliance Check
  license-check:
    name: License Compliance
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install license checker
        run: npm install -g license-checker

      - name: Check licenses
        run: |
          license-checker --json > licenses.json
          license-checker --summary

      - name: Verify no GPL licenses
        run: |
          if license-checker --onlyAllow 'MIT;Apache-2.0;BSD;ISC;CC0-1.0;Unlicense;0BSD' --production; then
            echo "âœ… All production licenses are compliant"
          else
            echo "::error::Found non-compliant licenses in production dependencies"
            exit 1
          fi

      - name: Upload license report
        uses: actions/upload-artifact@v4
        with:
          name: license-report
          path: licenses.json
          retention-days: 90

  # Update Dependencies (Auto PR)
  auto-update:
    name: Auto Update Dependencies
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Update patch and minor versions
        run: |
          # Update to latest patch/minor versions
          npm update

      - name: Run tests
        run: |
          npm ci
          npm run test:unit || echo "Tests failed - will not create PR"
        continue-on-error: true

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore(deps): update dependencies"
          title: "chore(deps): Weekly dependency updates"
          body: |
            ## Automated Dependency Updates

            This PR updates dependencies to their latest patch and minor versions.

            ### Changes
            - Updated npm dependencies using `npm update`
            - All tests have been run to verify compatibility

            ### Next Steps
            - Review the changes
            - Verify CI passes
            - Merge if all checks pass

            ---
            _This PR was automatically created by the dependency management workflow._
          branch: automated/dependency-updates
          delete-branch: true
          labels: |
            dependencies
            automated
            chore

  # Dependency Size Check
  bundle-impact:
    name: Bundle Size Impact
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout base branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.base_ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install base dependencies
        run: npm ci --prefer-offline

      - name: Build base
        run: npm run build
        env:
          NODE_ENV: production
          SKIP_ENV_VALIDATION: true

      - name: Get base bundle size
        run: |
          BASE_SIZE=$(du -sb .next | awk '{print $1}')
          echo "BASE_SIZE=$BASE_SIZE" >> $GITHUB_ENV
          echo "Base bundle size: $(($BASE_SIZE / 1024 / 1024))MB"

      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          clean: false

      - name: Install PR dependencies
        run: |
          rm -rf node_modules .next
          npm ci --prefer-offline

      - name: Build PR
        run: npm run build
        env:
          NODE_ENV: production
          SKIP_ENV_VALIDATION: true

      - name: Get PR bundle size
        run: |
          PR_SIZE=$(du -sb .next | awk '{print $1}')
          echo "PR_SIZE=$PR_SIZE" >> $GITHUB_ENV
          echo "PR bundle size: $(($PR_SIZE / 1024 / 1024))MB"

      - name: Calculate size difference
        run: |
          BASE_SIZE=${{ env.BASE_SIZE }}
          PR_SIZE=${{ env.PR_SIZE }}
          DIFF=$((PR_SIZE - BASE_SIZE))
          DIFF_MB=$((DIFF / 1024 / 1024))
          PERCENT=$(awk "BEGIN {printf \"%.2f\", ($DIFF / $BASE_SIZE) * 100}")

          echo "Size difference: ${DIFF_MB}MB (${PERCENT}%)"

          if [ $DIFF -gt 5242880 ]; then  # 5MB
            echo "::warning::Bundle size increased by ${DIFF_MB}MB (${PERCENT}%)"
          fi

      - name: Comment PR
        uses: actions/github-script@v7
        with:
          script: |
            const baseSize = parseInt(process.env.BASE_SIZE);
            const prSize = parseInt(process.env.PR_SIZE);
            const diff = prSize - baseSize;
            const diffMB = (diff / 1024 / 1024).toFixed(2);
            const baseMB = (baseSize / 1024 / 1024).toFixed(2);
            const prMB = (prSize / 1024 / 1024).toFixed(2);
            const percent = ((diff / baseSize) * 100).toFixed(2);

            const emoji = diff > 0 ? 'ðŸ“ˆ' : diff < 0 ? 'ðŸ“‰' : 'âž–';
            const symbol = diff > 0 ? '+' : '';

            const body = `## Bundle Size Impact ${emoji}

            | Metric | Value |
            |--------|-------|
            | Base Size | ${baseMB} MB |
            | PR Size | ${prMB} MB |
            | Difference | ${symbol}${diffMB} MB (${symbol}${percent}%) |

            ${diff > 5242880 ? 'âš ï¸ **Warning:** Bundle size increased by more than 5MB' : ''}
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  # Dependency Graph
  dependency-graph:
    name: Generate Dependency Graph
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: npm ci

      - name: Generate dependency graph
        run: |
          npx madge --image dependency-graph.svg --extensions ts,tsx,js,jsx app/ lib/

      - name: Upload dependency graph
        uses: actions/upload-artifact@v4
        with:
          name: dependency-graph
          path: dependency-graph.svg
          retention-days: 30

  # Summary Report
  summary:
    name: Dependency Summary
    runs-on: ubuntu-latest
    needs: [dependency-analysis, security-audit, license-check]
    if: always()
    steps:
      - name: Create summary
        run: |
          echo "# Dependency Management Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Job Results" >> $GITHUB_STEP_SUMMARY
          echo "- Dependency Analysis: ${{ needs.dependency-analysis.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Security Audit: ${{ needs.security-audit.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- License Check: ${{ needs.license-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "See individual jobs for detailed reports." >> $GITHUB_STEP_SUMMARY
